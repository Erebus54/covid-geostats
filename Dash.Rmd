---
title: "Covid GeoStats"
output: 
  flexdashboard::flex_dashboard:
    #orientation: rows
    social: menu
    theme: paper
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(rsconnect)
library(flexdashboard)
library(DT)
library(plotly)
library(RColorBrewer)

library(leaflet) 
library(leaflet.extras)

library(sf)

#download summary data 
PHU_Summary <- read.csv("./dataset/PHU_Summary.csv", encoding = "UTF-8")
#read spatial boundaries data 
PHU_bounds <- readRDS("./spatial files/PHU_Boundaries.rds")
```


GIS
===================================== 

Column {data-width=600}
-------------------------------------
    
### Map
    
```{r}

csum_map <- merge(PHU_bounds, PHU_Summary, by.x = "PHU_NAME_ENG", by.y = "Reporting_PHU" )
pal <- colorNumeric("viridis", domain = csum_map$Total_Cases, reverse = F)

popup = paste0("<b>Country: </b>")

#bbox <- st_bbox(csum_map) %>% 
 # as.vector()

#centers focus to current highest region via total cases 
bbox <- st_bbox(csum_map %>% dplyr::filter(Total_Cases == max(Total_Cases))) %>% 
  as.vector()


leaflet() %>% 
  
  #fitBounds(bbox[1], bbox[2], bbox[3], bbox[4]) %>% 
  setView(lat = mean(bbox[2], bbox[4]), 
          lng = mean(bbox[1], bbox[3]), 
          zoom = 9) %>%

  #addProviderTiles(providers$CartoDB.DarkMatter) %>% 
  
  addPolygons(data  = csum_map,
              fillColor = ~pal(Total_Cases), 
              weight = 1, 
              opacity = 1, 
              
              color = "white", 
              dashArray = 3, 
              fillOpacity = 0.5, 
              
              highlightOptions = highlightOptions(
                weight = 2, 
                color = "red", 
                fillOpacity = 0.5, 
                bringToFront = T), 
              
              # labelOptions = labelOptions(
              #   style = list("font-weight" = "normal", padding = "3px 8px"),
              #   textsize = "15px",
              #   direction = "auto")
              ) %>%
  
  addFullscreenControl() %>% 
  
  addResetMapButton() %>% 
  
  addLegend("bottomright", pal = pal, values = csum_map$Total_Cases, 
            title = "Total Cases", 
            opacity = 0.5)
```
   
Column {data-width=400}
-------------------------------------
   
### Table

```{r}
DT::datatable(data = PHU_Summary[, c("Reporting_PHU", "Total_Cases")] %>% dplyr::arrange(desc(Total_Cases)),
              class = 'cell-border stripe',
              colnames = c("Public Health Unit", "Total Cases"), 
              rownames = F, 
              options = list(dom = 't',ordering = F, page_length = 34, lengthChange = FALSE,
                             columnDefs = list(list(className = 'dt-center', targets="_all")))
)
```   
 
### Histogram
    
```{r}
PHU_Summary$Reporting_PHU <- factor(PHU_Summary$Reporting_PHU, 
                                      levels = unique(PHU_Summary$Reporting_PHU)[order(PHU_Summary$Total_Cases, decreasing = F)])

plot_ly(data = PHU_Summary, 
        y = ~Total_Cases, 
        x = ~Reporting_PHU, 
        type = 'bar', 
        name = "Total Cases",
        text = ~paste(Reporting_PHU, 
                      "<br>", 
                      format(PHU_Summary$Total_Cases, nsmall = 0, big.mark = ","), 
                      "Total Cases", 
                      sep = " "), 
        
        hoverinfo = "text", 
        marker = list(color = '#6EC5E9')
        ) %>% 
  
  layout(title = "<b> Total Cases Per Health Region </b>",
         xaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                      showgrid = FALSE, showticklabels = FALSE), 
         yaxis = list(title = "Total Cases"), 
         barmode = 'stack',
         hovermode = "y-unified", 
         hoverlabel=list(bgcolor="black"))
```


Outcomes 
===================================== 

Acquisition Type
===================================== 

Column {data-width=600}
-------------------------------------
    
### Dominant Acquisiton Type via Cases 
    
```{r}

#finding the most common acquistion method 
PHU_Summary$AcqMax <- colnames(PHU_Summary[,c("CloseContact", "Outbreak", "Travel", "Unknown")])[apply(PHU_Summary[,c("CloseContact", "Outbreak", "Travel", "Unknown")],1,which.max)]

Acq_map <- merge(PHU_bounds, PHU_Summary, by.x = "PHU_NAME_ENG", by.y = "Reporting_PHU" )

Acq_map$AcqMax <- ifelse(Acq_map$AcqMax == "CloseContact", paste0("Close Contact"), Acq_map$AcqMax)

#factpal <- colorFactor(topo.colors(3), Acq_map$AcqMax)
AcqCats <- colorFactor(palette = c("#6EC5E9", "#F4B400", "#9b4a11"), 
                       levels = c("Close Contact", "Outbreak", "Unkown"))
leaflet() %>% 
  
  setView(lat = mean(bbox[2], bbox[4]), 
          lng = mean(bbox[1], bbox[3]), 
          zoom = 9) %>%
  
  addPolygons(data  = Acq_map,
              fillColor = ~AcqCats(AcqMax), 
              weight = 1, 
              opacity = 1, 
              
              color = "white", 
              dashArray = 3, 
              fillOpacity = 1, 
              
              highlightOptions = highlightOptions(
                weight = 2, 
                color = "red", 
                fillOpacity = 1, 
                bringToFront = T), 
              
              # labelOptions = labelOptions(
              #   style = list("font-weight" = "normal", padding = "3px 8px"),
              #   textsize = "15px",
              #   direction = "auto")
  ) %>%
  
  addFullscreenControl() %>% 
  
  addResetMapButton() %>% 
  
  addLegend("bottomright", pal = AcqCats, values = Acq_map$AcqMax, 
            title = "Acquisition Type", 
            opacity = 1)
```
   
Column {data-width=400}
-------------------------------------
   
### Table

```{r}
```   
 
### Histogram
    
```{r}
```
Per Capita Rates
===================================== 


About this Site
===================================== 

#### Last Update  

`r format(Sys.time(), "%d %B, %Y")`

#### Background
*"Nothing in life is to be feared, it is only to be understood. Now is the time to understand more, so that we may fear less" - Marie Curie*  


#### Code
Code and input data used to generate this web app are available on [Github](https://github.com/Erebus54/covid-geostats).

#### Sources 

**Status of COVID-19 cases in Ontario** : [Open Data Ontario](https://data.ontario.ca/dataset/status-of-covid-19-cases-in-ontario), updated daily, which presents a breakdown by region, case status, age range of cases 

**Census Profile, 2016 Census** : [StatsCan](https://www12.statcan.gc.ca/census-recensement/2016/dp-pd/prof/index.cfm?Lang=E&TABID=1), queried this to obtain the areal size and population figures to compute the per capita metrics 

**Ministry of Health Public Health Unit Boundaries** : [Ontario GeoHub](https://geohub.lio.gov.on.ca/datasets/d8fba69152e4408dabfe70e85a2688d2_44), contains the geographic boundaries of all 34 Public Health Units (PHUs) in Ontario, based on Statistics Canadaâ€™s Health Region Boundary File (2018)

used to pull total population by health region and areal statistics to calculate per capita/density case loads 

#### Author 

Patrick Schnurbusch 

#### Contact 

patrick.schnurbusch@gmail.com
